<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products - TeleCart</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="/" class="sidebar-logo">
                    <div class="sidebar-logo-icon">üõí</div>
                    <span class="sidebar-logo-text">TeleCart</span>
                </a>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <a href="/" class="nav-link">
                        <i class="fas fa-chart-pie"></i>
                        <span>Dashboard</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Shop Management</div>
                    <a href="/products" class="nav-link active">
                        <i class="fas fa-box"></i>
                        <span>Products</span>
                    </a>
                    <a href="/categories" class="nav-link">
                        <i class="fas fa-folder"></i>
                        <span>Categories</span>
                    </a>
                    <a href="/orders" class="nav-link">
                        <i class="fas fa-shopping-cart"></i>
                        <span>Orders</span>
                    </a>
                    <a href="/customers" class="nav-link">
                        <i class="fas fa-users"></i>
                        <span>Customers</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Configuration</div>
                    <a href="/settings" class="nav-link">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <div class="header-left">
                    <h1 class="page-title">Products</h1>
                </div>
                <div class="header-right">
                    <button class="btn btn-primary" onclick="openAddProductModal()">
                        <i class="fas fa-plus"></i>
                        Add Product
                    </button>
                </div>
            </header>

            <div class="page-content">
                <div class="card">
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Category</th>
                                        <th>Price</th>
                                        <th>Stock</th>
                                        <th>Delivery</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="products-table">
                                    <tr>
                                        <td colspan="7" style="text-align: center; padding: 40px;">
                                            <div class="spinner" style="margin: 0 auto;"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Product Modal -->
    <div class="modal-overlay" id="product-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="product-modal-title">Add Product</h3>
                <button class="modal-close" onclick="closeModal('product-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="product-form">
                    <input type="hidden" id="product-id">
                    <div class="form-group">
                        <label class="form-label">Category *</label>
                        <select class="form-control" id="product-category" required>
                            <option value="">Select category...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Product Name *</label>
                        <input type="text" class="form-control" id="product-name" required
                            placeholder="e.g., Microsoft 365 Family - 12 months">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="product-description"
                            placeholder="Product details, benefits, etc."></textarea>
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label class="form-label">Price (USD) *</label>
                            <input type="number" class="form-control" id="product-price" required min="0" step="0.01"
                                placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Validity</label>
                            <input type="text" class="form-control" id="product-validity" placeholder="e.g., 12 months">
                        </div>
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label class="form-label">Delivery Type *</label>
                            <select class="form-control" id="product-delivery" required>
                                <option value="auto">Auto (Digital Keys)</option>
                                <option value="manual">Manual</option>
                            </select>
                        </div>
                        <div class="form-group" id="stock-group">
                            <label class="form-label">Stock (Manual)</label>
                            <input type="number" class="form-control" id="product-stock" min="0" value="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes (shown to customer)</label>
                        <textarea class="form-control" id="product-notes"
                            placeholder="Important notes for the customer..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="product-active" checked> Active (visible in bot)
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('product-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveProduct()">Save Product</button>
            </div>
        </div>
    </div>

    <!-- Add Keys Modal -->
    <div class="modal-overlay" id="keys-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Manage Keys - <span id="keys-product-name"></span></h3>
                <button class="modal-close" onclick="closeModal('keys-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="keys-product-id">

                <div class="form-group">
                    <label class="form-label">Add New Keys (one per line)</label>
                    <textarea class="form-control" id="new-keys" rows="5" placeholder="email1@example.com:password123
email2@example.com:password456
..."></textarea>
                </div>
                <button class="btn btn-success" onclick="addKeys()" style="margin-bottom: 20px;">
                    <i class="fas fa-plus"></i> Add Keys
                </button>

                <h4 style="margin-bottom: 15px;">Existing Keys</h4>
                <div id="keys-list" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script src="js/app.js"></script>
    <script>
        let categories = [];
        let products = [];

        async function loadProducts() {
            try {
                const [productsData, categoriesData] = await Promise.all([
                    apiGet('/products'),
                    apiGet('/categories')
                ]);

                products = productsData;
                categories = categoriesData;

                renderProducts();
                renderCategoryOptions();
            } catch (error) {
                console.error('Error loading products:', error);
                showToast('Failed to load products', 'error');
            }
        }

        function renderProducts() {
            const tbody = document.getElementById('products-table');

            if (products.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <i class="fas fa-box-open"></i>
                            <h3>No products yet</h3>
                            <p>Click "Add Product" to create your first product.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = products.map(product => {
                const stock = product.delivery_type === 'auto' ? product.available_keys : product.stock;
                const stockClass = stock === 0 ? 'danger' : stock <= 3 ? 'warning' : 'success';

                return `
                    <tr>
                        <td>
                            <strong>${product.name}</strong>
                            ${product.validity ? `<br><small style="color: var(--text-muted)">${product.validity}</small>` : ''}
                        </td>
                        <td>${product.category_name}</td>
                        <td>$${product.price_usd.toFixed(2)}</td>
                        <td><span class="badge badge-${stockClass}">${stock}</span></td>
                        <td><span class="badge badge-${product.delivery_type === 'auto' ? 'info' : 'primary'}">${product.delivery_type}</span></td>
                        <td><span class="badge badge-${product.is_active ? 'success' : 'danger'}">${product.is_active ? 'Active' : 'Inactive'}</span></td>
                        <td>
                            <div class="action-btns">
                                ${product.delivery_type === 'auto' ? `
                                    <button class="btn btn-secondary btn-sm btn-icon" onclick="openKeysModal(${product.id})" title="Manage Keys">
                                        <i class="fas fa-key"></i>
                                    </button>
                                ` : ''}
                                <button class="btn btn-secondary btn-sm btn-icon" onclick="editProduct(${product.id})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger btn-sm btn-icon" onclick="deleteProduct(${product.id})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderCategoryOptions() {
            const select = document.getElementById('product-category');
            select.innerHTML = '<option value="">Select category...</option>';

            // Build hierarchical options
            const parentCategories = categories.filter(c => !c.parent_id);
            parentCategories.forEach(parent => {
                select.innerHTML += `<option value="${parent.id}">${parent.emoji || 'üìÅ'} ${parent.name}</option>`;

                const children = categories.filter(c => c.parent_id === parent.id);
                children.forEach(child => {
                    select.innerHTML += `<option value="${child.id}">&nbsp;&nbsp;&nbsp;‚îî ${child.emoji || 'üìÅ'} ${child.name}</option>`;
                });
            });
        }

        function openAddProductModal() {
            document.getElementById('product-modal-title').textContent = 'Add Product';
            document.getElementById('product-form').reset();
            document.getElementById('product-id').value = '';
            document.getElementById('product-active').checked = true;
            updateStockVisibility();
            openModal('product-modal');
        }

        async function editProduct(id) {
            try {
                const product = await apiGet(`/products/${id}`);

                document.getElementById('product-modal-title').textContent = 'Edit Product';
                document.getElementById('product-id').value = product.id;
                document.getElementById('product-category').value = product.category_id;
                document.getElementById('product-name').value = product.name;
                document.getElementById('product-description').value = product.description || '';
                document.getElementById('product-price').value = product.price_usd;
                document.getElementById('product-validity').value = product.validity || '';
                document.getElementById('product-delivery').value = product.delivery_type;
                document.getElementById('product-stock').value = product.stock;
                document.getElementById('product-notes').value = product.notes || '';
                document.getElementById('product-active').checked = product.is_active;

                updateStockVisibility();
                openModal('product-modal');
            } catch (error) {
                showToast('Failed to load product', 'error');
            }
        }

        async function saveProduct() {
            const id = document.getElementById('product-id').value;
            const data = {
                category_id: parseInt(document.getElementById('product-category').value),
                name: document.getElementById('product-name').value,
                description: document.getElementById('product-description').value,
                price_usd: parseFloat(document.getElementById('product-price').value),
                validity: document.getElementById('product-validity').value,
                delivery_type: document.getElementById('product-delivery').value,
                stock: parseInt(document.getElementById('product-stock').value) || 0,
                notes: document.getElementById('product-notes').value,
                is_active: document.getElementById('product-active').checked
            };

            try {
                if (id) {
                    await apiPut(`/products/${id}`, data);
                    showToast('Product updated successfully');
                } else {
                    await apiPost('/products', data);
                    showToast('Product created successfully');
                }

                closeModal('product-modal');
                loadProducts();
            } catch (error) {
                showToast('Failed to save product', 'error');
            }
        }

        async function deleteProduct(id) {
            if (!await confirmAction('Are you sure you want to delete this product?')) return;

            try {
                await apiDelete(`/products/${id}`);
                showToast('Product deleted');
                loadProducts();
            } catch (error) {
                showToast('Failed to delete product', 'error');
            }
        }

        async function openKeysModal(productId) {
            const product = products.find(p => p.id === productId);
            document.getElementById('keys-product-id').value = productId;
            document.getElementById('keys-product-name').textContent = product.name;
            document.getElementById('new-keys').value = '';

            await loadKeys(productId);
            openModal('keys-modal');
        }

        async function loadKeys(productId) {
            try {
                const product = await apiGet(`/products/${productId}`);
                const list = document.getElementById('keys-list');

                if (!product.keys || product.keys.length === 0) {
                    list.innerHTML = '<p style="color: var(--text-muted)">No keys added yet.</p>';
                    return;
                }

                list.innerHTML = product.keys.map(key => `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 8px;">
                        <div style="flex: 1;">
                            <code style="color: var(--text-primary)">${key.key_data}</code>
                            ${key.is_sold ? '<span class="badge badge-success" style="margin-left: 10px">Sold</span>' : '<span class="badge badge-info" style="margin-left: 10px">Available</span>'}
                        </div>
                        ${!key.is_sold ? `
                            <button class="btn btn-danger btn-sm btn-icon" onclick="deleteKey(${productId}, ${key.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </div>
                `).join('');
            } catch (error) {
                showToast('Failed to load keys', 'error');
            }
        }

        async function addKeys() {
            const productId = document.getElementById('keys-product-id').value;
            const keysText = document.getElementById('new-keys').value.trim();

            if (!keysText) {
                showToast('Please enter at least one key', 'error');
                return;
            }

            const keys = keysText.split('\n').filter(k => k.trim());

            try {
                await apiPost(`/products/${productId}/keys`, { keys });
                showToast(`${keys.length} key(s) added successfully`);
                document.getElementById('new-keys').value = '';
                await loadKeys(productId);
                loadProducts(); // Refresh product list to update stock count
            } catch (error) {
                showToast('Failed to add keys', 'error');
            }
        }

        async function deleteKey(productId, keyId) {
            if (!await confirmAction('Delete this key?')) return;

            try {
                await apiDelete(`/products/${productId}/keys/${keyId}`);
                showToast('Key deleted');
                await loadKeys(productId);
                loadProducts();
            } catch (error) {
                showToast('Failed to delete key', 'error');
            }
        }

        function updateStockVisibility() {
            const deliveryType = document.getElementById('product-delivery').value;
            const stockGroup = document.getElementById('stock-group');
            stockGroup.style.display = deliveryType === 'manual' ? 'block' : 'none';
        }

        document.getElementById('product-delivery').addEventListener('change', updateStockVisibility);

        // Load on page load
        loadProducts();
    </script>
</body>

</html>