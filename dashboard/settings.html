<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - AlphaDigit</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="/" class="sidebar-logo">
                    <div class="sidebar-logo-icon">üõí</div>
                    <span class="sidebar-logo-text">AlphaDigit</span>
                </a>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <a href="/" class="nav-link">
                        <i class="fas fa-chart-pie"></i>
                        <span>Dashboard</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Shop Management</div>
                    <a href="/products" class="nav-link">
                        <i class="fas fa-box"></i>
                        <span>Products</span>
                    </a>
                    <a href="/categories" class="nav-link">
                        <i class="fas fa-folder"></i>
                        <span>Categories</span>
                    </a>
                    <a href="/orders" class="nav-link">
                        <i class="fas fa-shopping-cart"></i>
                        <span>Orders</span>
                    </a>
                    <a href="/customers" class="nav-link">
                        <i class="fas fa-users"></i>
                        <span>Customers</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Configuration</div>
                    <a href="/settings" class="nav-link active">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <div class="header-left">
                    <h1 class="page-title">Settings</h1>
                </div>
                <div class="header-right">
                    <button class="btn btn-primary" onclick="saveSettings()">
                        <i class="fas fa-save"></i>
                        Save Settings
                    </button>
                </div>
            </header>

            <div class="page-content">
                <!-- Bot Settings -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fab fa-telegram"></i>
                            Bot Settings
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">Bot Name</label>
                                <input type="text" class="form-control" id="bot_name" placeholder="AlphaDigit">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Low Stock Threshold</label>
                                <input type="number" class="form-control" id="low_stock_threshold" min="1"
                                    placeholder="3">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Bot Token <small style="color: var(--text-muted);">(from
                                    @BotFather)</small></label>
                            <div style="display: flex; gap: 10px;">
                                <input type="password" class="form-control" id="bot_token"
                                    placeholder="Enter new bot token to update...">
                                <button class="btn btn-secondary" type="button" onclick="toggleTokenVisibility()"
                                    id="toggle-token-btn">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <small style="color: var(--text-muted);">‚ö†Ô∏è Server restart required after changing
                                token</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Welcome Message</label>
                            <textarea class="form-control" id="welcome_message" rows="4"
                                placeholder="Welcome message shown to new users..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Currency & Payment Settings -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-credit-card"></i>
                            Currency & Payment
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Store Currency</label>
                            <select class="form-control" id="store_currency" onchange="togglePaymentSettings()">
                                <option value="USD">üíµ USD - US Dollar (Binance Pay / CryptoPay)</option>
                                <option value="DZD">üá©üáø DZD - Algerian Dinar (BaridiMob)</option>
                            </select>
                            <small style="color: var(--text-muted)">
                                USD uses Binance Pay for auto-verification. DZD uses BaridiMob for manual verification.
                            </small>
                        </div>

                        <!-- Binance Pay Settings (USD) -->
                        <div id="coinpal-settings" style="margin-top: 20px;">
                            <hr style="border-color: var(--border-color); margin: 20px 0;">
                            <h4 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                <span style="color: #F0B90B;">üíõ</span> Binance Pay (Auto-Verification)
                            </h4>
                            <div class="alert alert-info" style="margin-bottom: 15px;">
                                <i class="fas fa-info-circle"></i>
                                <div>
                                    <strong>How it works:</strong> Users pay to your Binance Pay ID, enter the Order ID,
                                    and the bot automatically verifies & credits their balance!
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Binance Pay ID (UID)</label>
                                <input type="text" class="form-control" id="binance_pay_id"
                                    placeholder="Your Binance UID (e.g., 123456789)">
                                <small style="color: var(--text-muted)">
                                    Find in Binance app ‚Üí Profile ‚Üí User ID
                                </small>
                            </div>

                            <h5 style="margin: 20px 0 15px; color: var(--text-muted);">
                                <i class="fas fa-key"></i> API Credentials (for auto-verification)
                            </h5>
                            <div class="alert alert-warning" style="margin-bottom: 15px;">
                                <i class="fas fa-shield-alt"></i>
                                <div>
                                    <strong>Security:</strong> Create an API key with <strong>ONLY "Enable
                                        Reading"</strong> permission.
                                    Never enable trading or withdrawal permissions!
                                </div>
                            </div>

                            <div class="grid-2">
                                <div class="form-group">
                                    <label class="form-label">Binance API Key</label>
                                    <input type="text" class="form-control" id="binance_api_key"
                                        placeholder="Your API Key">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Binance API Secret</label>
                                    <input type="password" class="form-control" id="binance_api_secret"
                                        placeholder="Your API Secret">
                                </div>
                            </div>

                            <div class="alert"
                                style="background: rgba(240, 185, 11, 0.1); border: 1px solid rgba(240, 185, 11, 0.3); margin-top: 15px;">
                                <i class="fas fa-lightbulb" style="color: #F0B90B;"></i>
                                <div>
                                    <strong>How to get API keys:</strong>
                                    <ol style="margin: 10px 0 0 20px; color: var(--text-muted);">
                                        <li>Go to <a href="https://www.binance.com/en/my/settings/api-management"
                                                target="_blank">Binance API Management</a></li>
                                        <li>Click "Create API" ‚Üí Choose "System Generated"</li>
                                        <li>Enable ONLY "Enable Reading" permission</li>
                                        <li>Copy the API Key and Secret Key</li>
                                    </ol>
                                </div>
                            </div>
                        </div>

                        <!-- BaridiMob Settings (DZD) -->
                        <div id="baridimob-settings" style="margin-top: 20px; display: none;">
                            <hr style="border-color: var(--border-color); margin: 20px 0;">
                            <h4 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                <span style="color: #FFD700;">üè¶</span> BaridiMob (Algeria)
                            </h4>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label class="form-label">RIP Number</label>
                                    <input type="text" class="form-control" id="baridimob_rip" placeholder="007999...">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Account Holder Name</label>
                                    <input type="text" class="form-control" id="baridimob_name"
                                        placeholder="Your name as shown on account">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Security Settings -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-shield-alt"></i>
                            Security Settings
                        </h3>
                    </div>
                    <div class="card-body">
                        <h4 style="margin-bottom: 15px;">üîê Change Dashboard Password</h4>
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">Current Password</label>
                                <input type="password" class="form-control" id="current_password"
                                    placeholder="Enter current password">
                            </div>
                            <div class="form-group">
                                <label class="form-label">New Password</label>
                                <input type="password" class="form-control" id="new_password"
                                    placeholder="Enter new password (min 6 chars)">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="changePassword()" style="margin-top: 10px;">
                            <i class="fas fa-key"></i> Change Password
                        </button>
                        <small style="display: block; margin-top: 10px; color: var(--text-muted);">
                            After changing password, you'll need to log in again with the new password.
                        </small>
                    </div>
                </div>

                <!-- Broadcast Message -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-bullhorn"></i>
                            Broadcast Message
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info" style="margin-bottom: 15px;">
                            <i class="fas fa-info-circle"></i>
                            <div>Send a message to all your bot users. Great for announcements, promotions, or updates!
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Message</label>
                            <textarea class="form-control" id="broadcast_message" rows="4"
                                placeholder="Type your message here... (Supports Markdown: *bold*, _italic_, `code`)"></textarea>
                        </div>
                        <div class="form-group" style="margin-top: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="include_inactive" style="width: 18px; height: 18px;">
                                <span>Include inactive users (not active in last 30 days)</span>
                            </label>
                        </div>
                        <button class="btn btn-success" onclick="sendBroadcast()" style="margin-top: 10px;">
                            <i class="fas fa-paper-plane"></i> Send Broadcast
                        </button>
                    </div>
                </div>

                <!-- Quick Guide -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-book"></i>
                            Quick Guide
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <div>
                                <strong>Getting Started:</strong>
                                <ol style="margin: 10px 0 0 20px;">
                                    <li>Choose your currency (USD or DZD)</li>
                                    <li>Configure your payment method above</li>
                                    <li>Create categories for your products</li>
                                    <li>Add products with prices</li>
                                    <li>Share your bot link with customers!</li>
                                </ol>
                            </div>
                        </div>
                        <div style="margin-top: 20px;">
                            <p><strong>Your Bot Link:</strong></p>
                            <a href="https://t.me/Alpha_Digit_bot" target="_blank" class="btn btn-primary"
                                style="margin-top: 10px;">
                                <i class="fab fa-telegram"></i>
                                https://t.me/Alpha_Digit_bot
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script src="js/app.js"></script>
    <script>
        function togglePaymentSettings() {
            const currency = document.getElementById('store_currency').value;
            const coinpalSettings = document.getElementById('coinpal-settings');
            const baridimobSettings = document.getElementById('baridimob-settings');

            if (currency === 'USD') {
                coinpalSettings.style.display = 'block';
                baridimobSettings.style.display = 'none';
            } else {
                coinpalSettings.style.display = 'none';
                baridimobSettings.style.display = 'block';
            }
        }

        async function loadSettings() {
            try {
                const settings = await apiGet('/settings');

                document.getElementById('bot_name').value = settings.bot_name || '';
                document.getElementById('welcome_message').value = settings.welcome_message || '';
                document.getElementById('low_stock_threshold').value = settings.low_stock_threshold || '3';
                document.getElementById('store_currency').value = settings.store_currency || 'USD';
                document.getElementById('binance_pay_id').value = settings.binance_pay_id || '';
                document.getElementById('binance_api_key').value = settings.binance_api_key || '';
                document.getElementById('binance_api_secret').value = settings.binance_api_secret || '';
                document.getElementById('baridimob_rip').value = settings.baridimob_rip || '';
                document.getElementById('baridimob_name').value = settings.baridimob_name || '';

                togglePaymentSettings();
            } catch (error) {
                console.error('Error loading settings:', error);
                showToast('Failed to load settings', 'error');
            }
        }

        async function saveSettings() {
            const botTokenInput = document.getElementById('bot_token').value;
            const settings = {
                bot_name: document.getElementById('bot_name').value,
                welcome_message: document.getElementById('welcome_message').value,
                low_stock_threshold: document.getElementById('low_stock_threshold').value,
                store_currency: document.getElementById('store_currency').value,
                binance_pay_id: document.getElementById('binance_pay_id').value,
                binance_api_key: document.getElementById('binance_api_key').value,
                binance_api_secret: document.getElementById('binance_api_secret').value,
                baridimob_rip: document.getElementById('baridimob_rip').value,
                baridimob_name: document.getElementById('baridimob_name').value
            };

            // Only include bot_token if user entered a new one
            if (botTokenInput && botTokenInput.trim()) {
                settings.bot_token = botTokenInput.trim();
            }

            try {
                await apiPut('/settings', settings);
                if (settings.bot_token) {
                    showToast('Settings saved! Restart server to apply new bot token.');
                    document.getElementById('bot_token').value = ''; // Clear field
                } else {
                    showToast('Settings saved successfully');
                }
            } catch (error) {
                showToast('Failed to save settings', 'error');
            }
        }

        async function changePassword() {
            const currentPassword = document.getElementById('current_password').value;
            const newPassword = document.getElementById('new_password').value;

            if (!currentPassword || !newPassword) {
                showToast('Please fill in both password fields', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showToast('New password must be at least 6 characters', 'error');
                return;
            }

            try {
                const response = await fetch('/api/admin/password', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ currentPassword, newPassword })
                });

                const data = await response.json();

                if (response.ok) {
                    showToast('Password changed! Please log in again.');
                    document.getElementById('current_password').value = '';
                    document.getElementById('new_password').value = '';
                    // Force re-login after password change
                    setTimeout(() => {
                        window.location.href = '/settings';
                    }, 1500);
                } else {
                    showToast(data.error || 'Failed to change password', 'error');
                }
            } catch (error) {
                showToast('Error changing password', 'error');
            }
        }

        async function sendBroadcast() {
            const message = document.getElementById('broadcast_message').value;
            const includeInactive = document.getElementById('include_inactive').checked;

            if (!message.trim()) {
                showToast('Please enter a message', 'error');
                return;
            }

            if (!confirm('Send this message to all users?')) {
                return;
            }

            try {
                const response = await fetch('/api/broadcast', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, includeInactive })
                });

                const data = await response.json();

                if (response.ok) {
                    showToast(`Broadcast queued for ${data.recipients} users!`);
                    document.getElementById('broadcast_message').value = '';
                } else {
                    showToast(data.error || 'Failed to send broadcast', 'error');
                }
            } catch (error) {
                showToast('Error sending broadcast', 'error');
            }
        }

        function toggleTokenVisibility() {
            const tokenInput = document.getElementById('bot_token');
            const toggleBtn = document.getElementById('toggle-token-btn');
            if (tokenInput.type === 'password') {
                tokenInput.type = 'text';
                toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
            } else {
                tokenInput.type = 'password';
                toggleBtn.innerHTML = '<i class="fas fa-eye"></i>';
            }
        }

        // Load on page load
        loadSettings();
    </script>
</body>

</html>